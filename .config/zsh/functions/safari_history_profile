# shellcheck disable=SC2168 shell=bash

local rows=${1:-20}

local DEFAULT_HISTORY_DB="$HOME/Library/Safari/History.db"
local SAFARI_TABS_DB="$HOME/Library/Containers/com.apple.Safari/Data/Library/Safari/SafariTabs.db"
local PROFILES_DIR="$HOME/Library/Containers/com.apple.Safari/Data/Library/Safari/Profiles"
local COLUMN_MAX=90

show_history() {
    local profile="$1"
    local db="$2"

    h1 "$profile"
    echo
    if [[ -f "$db" ]]; then
        sqlite3 -batch -init /dev/null -column -header "$db" "
            select
                datetime(v.visit_time + 978307200, 'unixepoch', 'localtime') as 'date visited',
                i.domain_expansion as 'domain expansion',
                case when length(i.url) > $COLUMN_MAX then substr(i.url, 1, $COLUMN_MAX) || '...' else i.url end as 'url address',
                case when length(v.title) > $COLUMN_MAX then substr(v.title, 1, $COLUMN_MAX) || '...' else v.title end as 'page title'
            from history_items i left join history_visits v on i.id = v.history_item
            order by i.id desc
            limit $rows;
        "
    else
        echo "No History.db found for profile: $profile ($db)"
    fi
}

list_profiles() {
    sqlite3 -batch -init /dev/null "$SAFARI_TABS_DB" "
        select title, external_uuid
        from bookmarks
        where type=1 and subtype=2 and title <> '';
    "
}

show_history "Default" "$DEFAULT_HISTORY_DB"
list_profiles | while IFS='|' read -r profile uuid; do
    show_history "$profile" "$PROFILES_DIR/$uuid/History.db"
done
